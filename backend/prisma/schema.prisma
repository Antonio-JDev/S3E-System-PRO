// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTENTICAÇÃO E USUÁRIOS
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user") // admin, orcamentista, compras, gerente, tecnico, desenvolvedor
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  pdfTemplates        PDFTemplate[]
  projetosResponsavel Projeto[]           @relation("ProjetoResponsavel")
  auditLogs           AuditLog[]
  alocacoes           AlocacaoObra[]      @relation("AlocacaoEletricista")
  registrosAtividade  RegistroAtividade[] @relation("RegistrosAtividade")
  kitsFerramentas     KitFerramenta[]     @relation("KitEletricista")

  @@map("users")
}

// Log de Auditoria do Sistema
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  userName    String?
  userRole    String?
  action      String // LOGIN, LOGOUT, CREATE, UPDATE, DELETE, ACCESS, etc
  entity      String? // Projeto, Orcamento, Cliente, etc
  entityId    String?
  description String
  ipAddress   String?
  userAgent   String?
  metadata    Json? // Dados adicionais em JSON
  createdAt   DateTime @default(now())

  // Campos adicionais para auditoria imutável em cadeia (ex: NF-e)
  hash         String? // Hash SHA-256 deste registro
  previousHash String? // Hash do registro anterior na mesma cadeia
  chainId      String? // Identificador lógico da cadeia (ex: chave de acesso da NF-e)
  sequence     Int? // Ordem dentro da cadeia (1, 2, 3, ...)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entity, entityId])
  @@index([chainId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Templates de Customização de PDF
model PDFTemplate {
  id           String  @id @default(uuid())
  userId       String
  templateName String
  description  String?

  // Configurações de Customização (JSON)
  customization Json // Armazena toda a configuração PDFCustomization

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("pdf_templates")
}

model ConfiguracaoSistema {
  id              String   @id @default("sistema-config") // ID fixo para garantir registro único
  temaPreferido   String   @default("light") // light, dark, system
  logoUrl         String? // URL da logo/perfil da empresa (uso geral)
  logoLoginUrl    String? // URL da logo específica para a página de login
  logoDanfeUrl    String? // URL da logo específica para impressão na DANFE
  nomeEmpresa     String   @default("S3E Engenharia")
  emailContato    String?
  telefoneContato String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("configuracoes_sistema")
}

// ============================================
// CADASTROS BÁSICOS
// ============================================

model Cliente {
  id        String   @id @default(uuid())
  nome      String
  cpfCnpj   String   @unique
  email     String?
  telefone  String?
  endereco  String?
  cidade    String?
  estado    String?
  cep       String?
  tipo      String   @default("PJ") // PF (Pessoa Física) ou PJ (Pessoa Jurídica)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orcamentos Orcamento[]
  projetos   Projeto[]
  vendas     Venda[]
  obras      Obra[] // ✅ Relação com obras de manutenção

  @@map("clientes")
}

model Fornecedor {
  id        String   @id @default(uuid())
  nome      String
  cnpj      String   @unique
  email     String?
  telefone  String?
  endereco  String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materiais   Material[]
  compras     Compra[]
  contasPagar ContaPagar[]
  cotacoes    Cotacao[] // Novo: cotações do fornecedor

  @@map("fornecedores")
}

// ============================================
// ESTOQUE E MATERIAIS
// ============================================

model Material {
  id            String  @id @default(uuid())
  nome          String
  sku           String  @unique
  tipo          String // Tipo do material
  categoria     String // MaterialEletrico, Insumo, Ferramenta
  descricao     String?
  ncm           String? // Nomenclatura Comum do Mercosul (dado fiscal)
  estoque       Float   @default(0)
  estoqueMinimo Float   @default(5)
  unidadeMedida String  @default("un")
  localizacao   String?
  imagemUrl     String? // URL da imagem do material

  preco                  Float? // Preço de custo (última compra)
  valorVenda             Float? // Preço de venda (usado em orçamentos)
  porcentagemLucro       Float? // Porcentagem de lucro ((valorVenda - preco) / preco * 100)
  ultimaAtualizacaoPreco DateTime? // Data da última atualização de preço
  fornecedorId           String?
  // Campos de fracionamento (para materiais vendidos em caixas/pacotes)
  quantidadePorEmbalagem Float? // Quantidade padrão de unidades por embalagem (ex: 100)
  tipoEmbalagem          String? // Tipo de embalagem padrão: "CAIXA", "PACOTE", "FARDO", etc.
  precoEmbalagem         Float? // Preço da embalagem completa (para materiais fracionados)
  precoUnitario          Float? // Preço calculado por unidade individual (precoEmbalagem / quantidadePorEmbalagem)
  ativo                  Boolean   @default(true)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  fornecedor      Fornecedor?           @relation(fields: [fornecedorId], references: [id])
  kitItems        KitItem[]
  orcamentoItems  OrcamentoItem[]
  compraItems     CompraItem[]
  movimentacoes   MovimentacaoEstoque[]
  historicoPrecos HistoricoPreco[]

  @@map("materiais")
}

// Histórico de alterações de preços
model HistoricoPreco {
  id          String   @id @default(uuid())
  materialId  String
  precoAntigo Float?
  precoNovo   Float
  motivo      String? // Ex: "Atualização de mercado", "Importação JSON"
  usuario     String? // Quem fez a alteração
  createdAt   DateTime @default(now())

  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@index([createdAt])
  @@map("historico_precos")
}

// Banco de Cotações (materiais cotados - banco frio)
model Cotacao {
  id              String   @id @default(uuid())
  nome            String
  ncm             String?
  valorUnitario   Float
  valorVenda      Float? // Valor de venda (padrão: valorUnitario * 1.4 = 40% de margem)
  fornecedorId    String?
  fornecedorNome  String? // Nome do fornecedor (redundante para performance)
  dataAtualizacao DateTime @default(now()) // Data da última cotação
  observacoes     String?
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  fornecedor     Fornecedor?     @relation(fields: [fornecedorId], references: [id])
  itensOrcamento OrcamentoItem[] // Relação com itens de orçamento

  @@index([fornecedorId])
  @@index([dataAtualizacao])
  @@index([ativo])
  @@map("cotacoes")
}

model Servico {
  id          String      @id @default(uuid())
  nome        String
  codigo      String      @unique
  descricao   String?
  tipo        String // Instalacao, Manutencao, Consultoria, LaudoTecnico
  tipoServico TipoServico @default(MAO_DE_OBRA) // ✅ NOVO: Tipo de serviço para classificação
  preco       Float
  custo       Float?      // ✅ NOVO: Custo do serviço (opcional)
  unidade     String      @default("un") // un, hora, m2, etc
  ativo       Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("servicos")
}

model Kit {
  id        String  @id @default(uuid())
  nome      String
  descricao String?
  preco     Float
  tipo      String // medidores, comando, quadro-eletrico, subestacoes
  ativo     Boolean @default(true)

  // Controle de Estoque para Quadros Elétricos
  temItensCotacao Boolean @default(false) // Se tem itens do banco frio (cotações)
  itensFaltantes  Json? // Array de {materialId, quantidade, nome} dos itens que faltam em estoque
  statusEstoque   String  @default("COMPLETO") // COMPLETO, PENDENTE, PARCIAL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items          KitItem[]
  orcamentoItems OrcamentoItem[]

  @@map("kits")
}

model KitItem {
  id         String @id @default(uuid())
  kitId      String
  materialId String
  quantidade Float

  kit      Kit      @relation(fields: [kitId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id])

  @@map("kit_items")
}

// ============================================
// ORÇAMENTOS
// ============================================

model Orcamento {
  id               String   @id @default(uuid())
  numeroSequencial Int      @unique @default(autoincrement()) // Número sequencial automático
  clienteId        String
  titulo           String
  descricao        String? // HTML do Quill editor ou texto rico
  descricaoProjeto String? // Descrição técnica avançada do projeto
  validade         DateTime
  status           String   @default("Pendente") // Pendente, Enviado ao Cliente, Aprovado, Recusado, Declinado, Cancelado
  bdi              Float    @default(0) // Margem de lucro (%)
  custoTotal       Float    @default(0)
  precoVenda       Float    @default(0)
  observacoes      String?

  // NOVOS CAMPOS - Engenharia Elétrica
  empresaCNPJ       String? // CNPJ da empresa executora
  enderecoObra      String? // Endereço completo da obra
  cidade            String? // Cidade da obra
  bairro            String? // Bairro da obra
  cep               String? // CEP da obra
  responsavelObra   String? // Responsável técnico no local
  previsaoInicio    DateTime? // Data prevista de início
  previsaoTermino   DateTime? // Data prevista de término
  descontoValor     Float     @default(0) // Desconto em R$
  impostoPercentual Float     @default(0) // Impostos em %
  condicaoPagamento String? // Ex: "À Vista", "30/60/90 dias"

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  aprovedAt    DateTime?
  recusadoAt   DateTime?
  motivoRecusa String? // Motivo da recusa (se aplicável)

  cliente Cliente         @relation(fields: [clienteId], references: [id])
  items   OrcamentoItem[]
  fotos   OrcamentoFoto[]
  projeto Projeto?
  venda   Venda? // Relação 1:1 com venda (quando orçamento é vendido)

  @@map("orcamentos")
}

model OrcamentoItem {
  id          String  @id @default(uuid())
  orcamentoId String
  tipo        String // MATERIAL, KIT, SERVICO, QUADRO_PRONTO, CUSTO_EXTRA, COTACAO
  materialId  String?
  kitId       String?
  cotacaoId   String? // Novo: material do banco de cotações (banco frio)
  servicoNome String? // Para serviços avulsos
  descricao   String? // Descrição adicional do item
  quantidade  Float
  custoUnit   Float
  precoUnit   Float
  subtotal    Float
  ncm         String? // Nomenclatura Comum do Mercosul (para faturamento NF-e/NFS-e)

  // ✅ NOVOS CAMPOS: Conversão de unidades (OPCIONAIS para compatibilidade)
  unidadeVenda String? // Unidade de venda (ex: 'cm' para barramentos, pode ser diferente da unidade de estoque)
  tipoMaterial String? // Tipo do material: BARRAMENTO_COBRE, TRILHO_DIN, CABO, PADRAO

  // ✅ Campo para armazenar itens de kits customizados criados no orçamento
  itensDoKit Json? // Array de objetos com {nome, codigo, valorVenda, quantidade, materialId?, cotacaoId?}

  orcamento Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  material  Material? @relation(fields: [materialId], references: [id])
  kit       Kit?      @relation(fields: [kitId], references: [id])
  cotacao   Cotacao?  @relation(fields: [cotacaoId], references: [id]) // Novo

  @@index([cotacaoId])
  @@map("orcamento_items")
}

model OrcamentoFoto {
  id          String   @id @default(uuid())
  orcamentoId String
  url         String // URL da foto armazenada
  legenda     String? // Descrição/legenda da foto
  ordem       Int      @default(0) // Ordem de exibição
  createdAt   DateTime @default(now())

  orcamento Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)

  @@map("orcamento_fotos")
}

// ============================================
// PROJETOS E KANBAN
// ============================================

enum ProjetoStatus {
  PROPOSTA
  VALIDADO
  APROVADO
  EXECUCAO
  CONCLUIDO
  CANCELADO
}

// Tipo de Serviço
enum TipoServico {
  MAO_DE_OBRA
  MONTAGEM
  ENGENHARIA
  PROJETOS
  ADMINISTRATIVO
}

model Projeto {
  id            String        @id @default(uuid())
  orcamentoId   String        @unique
  clienteId     String
  responsavelId String?
  titulo        String
  descricao     String?
  tipo          String        @default("Instalacao") // Instalacao, Manutencao, Retrofit, Automacao
  valorTotal    Float         @default(0)
  dataInicio    DateTime      @default(now())
  dataPrevisao  DateTime?
  dataFim       DateTime?
  dataConclusao DateTime?
  status        ProjetoStatus @default(PROPOSTA)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  orcamento    Orcamento          @relation(fields: [orcamentoId], references: [id])
  cliente      Cliente            @relation(fields: [clienteId], references: [id])
  responsavel  User?              @relation("ProjetoResponsavel", fields: [responsavelId], references: [id])
  tasks        Task[]
  notasFiscais NotaFiscal[]
  vendas       Venda[]
  alocacoes    AlocacaoObra[]
  etapasAdmin  EtapaAdmin[]
  tarefasCampo TarefaCampo[]
  obra         Obra? // Relação 1:1 com Obra (quando projeto vai para execução)
  documentos   ProjetoDocumento[]

  @@map("projetos")
}

model EtapaAdmin {
  id             String    @id @default(uuid())
  projetoId      String
  tipo           String // ABERTURA_SR, EMITIR_ART, etc.
  ordem          Int // Ordem de execução (1-10)
  concluida      Boolean   @default(false)
  dataInicio     DateTime? // Quando foi iniciada
  dataPrevista   DateTime // Prazo previsto (24h por padrão)
  dataConclusao  DateTime? // Quando foi concluída
  observacoes    String?
  motivoExtensao String? // Motivo para extensão de prazo
  // Campos compatíveis com especificação solicitada
  nome           String? // alias para exibição
  dataExpiracao  DateTime? // espelha dataPrevista
  realizada      Boolean? // espelha concluida
  justificativa  String? // alias para motivo de adiamento
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@index([projetoId])
  @@index([tipo])
  @@index([concluida])
  @@map("etapas_admin")
}

enum TarefaCampoStatus {
  A_FAZER
  EM_ANDAMENTO
  CONCLUIDO
}

model Task {
  id          String    @id @default(uuid())
  projetoId   String
  titulo      String
  descricao   String?
  status      String    @default("ToDo") // ToDo, Doing, Done
  prioridade  String    @default("Media") // Baixa, Media, Alta
  prazo       DateTime?
  responsavel String?
  ordem       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model ProjetoDocumento {
  id          String   @id @default(uuid())
  projetoId   String
  tipo        String // ART, TRT, PROJETO, MEMORIAL, CONTRATO, OUTRO
  nome        String // Nome do arquivo original
  nomeArquivo String // Nome do arquivo salvo no servidor
  url         String // URL do arquivo (caminho relativo)
  observacoes String?
  tamanho     Int? // Tamanho do arquivo em bytes
  mimeType    String? // Tipo MIME do arquivo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@index([projetoId])
  @@index([tipo])
  @@map("projeto_documentos")
}

model TarefaCampo {
  id            String            @id @default(uuid())
  projetoId     String
  titulo        String
  descricao     String?
  status        TarefaCampoStatus @default(A_FAZER)
  responsavelId String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@index([projetoId])
  @@map("tarefas_campo")
}

// ============================================
// PESSOAS / TÉCNICOS DE CAMPO
// ============================================

enum FuncaoPessoa {
  TECNICO_1
  ELETRICISTA_2
  ENGENHEIRO
  AUXILIAR
}

model Pessoa {
  id         String       @id @default(uuid())
  nome       String
  email      String?      @unique
  funcao     FuncaoPessoa
  disponivel Boolean      @default(true)
  ativo      Boolean      @default(true)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@map("pessoas")
}

// ============================================
// COMPRAS
// ============================================

model Compra {
  id               String    @id @default(uuid())
  numeroSequencial Int       @unique @default(autoincrement()) // Número sequencial automático
  fornecedorId     String
  fornecedorNome   String
  fornecedorCNPJ   String
  fornecedorTel    String?
  numeroNF         String
  serieNF          String? // Série da Nota Fiscal (ex: "1", "2", etc.)
  dataEmissaoNF    DateTime
  dataCompra       DateTime
  dataRecebimento  DateTime?
  valorSubtotal    Float
  valorFrete       Float     @default(0)
  outrasDespesas   Float     @default(0)
  valorTotal       Float
  status           String    @default("Pendente") // Pendente, Recebido, Cancelado
  xmlData          String? // JSON string com dados completos do XML
  observacoes      String?
  obraId           String? // ✅ NOVO: Obra vinculada (para compras avulsas de obras em andamento)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  fornecedor Fornecedor   @relation(fields: [fornecedorId], references: [id])
  obra       Obra?        @relation(fields: [obraId], references: [id]) // ✅ NOVO: Relação com Obra
  items      CompraItem[]

  @@map("compras")
}

model CompraItem {
  id          String  @id @default(uuid())
  compraId    String
  materialId  String?
  nomeProduto String
  ncm         String?
  quantidade  Float // Quantidade de embalagens
  valorUnit   Float // Preço por embalagem
  valorTotal  Float
  // Campos de fracionamento
  quantidadeFracionada Float? // Quantidade de unidades individuais dentro do pacote/caixa (ex: 100)
  tipoEmbalagem       String? // Tipo de embalagem: "CAIXA", "PACOTE", "FARDO", etc.
  unidadeEmbalagem    String? // Unidade da embalagem: "cx", "pct", "fardo", etc.
  fracionamentoAplicado Boolean @default(false) // ✅ Marca se o fracionamento já foi aplicado ao estoque

  compra   Compra    @relation(fields: [compraId], references: [id], onDelete: Cascade)
  material Material? @relation(fields: [materialId], references: [id])

  @@map("compra_items")
}

// ============================================
// MOVIMENTAÇÃO DE ESTOQUE
// ============================================

model MovimentacaoEstoque {
  id          String   @id @default(uuid())
  materialId  String
  tipo        String // ENTRADA, SAIDA, AJUSTE
  quantidade  Float
  motivo      String // COMPRA, VENDA, PROJETO, DEVOLUCAO, AJUSTE
  referencia  String? // ID da compra, projeto, etc
  observacoes String?
  data        DateTime @default(now())
  createdAt   DateTime @default(now())

  material Material @relation(fields: [materialId], references: [id])

  @@map("movimentacoes_estoque")
}

// ============================================
// VENDAS E FINANCEIRO
// ============================================

model Venda {
  id             String   @id @default(uuid())
  numeroVenda    String   @unique
  orcamentoId    String   @unique // Vínculo com orçamento aprovado
  dataVenda      DateTime @default(now())
  valorTotal     Float
  status         String   @default("Pendente") // Pendente, Concluida, Cancelada
  clienteId      String
  projetoId      String?
  formaPagamento String   @default("À vista") // À vista, Parcelado, Boleto, PIX
  parcelas       Int      @default(1)
  valorEntrada   Float    @default(0)
  observacoes    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  orcamento     Orcamento      @relation(fields: [orcamentoId], references: [id])
  cliente       Cliente        @relation(fields: [clienteId], references: [id])
  projeto       Projeto?       @relation(fields: [projetoId], references: [id])
  contasReceber ContaReceber[]

  @@map("vendas")
}

model ContaReceber {
  id             String    @id @default(uuid())
  vendaId        String
  descricao      String
  valorParcela   Float
  dataVencimento DateTime
  dataPagamento  DateTime?
  status         String    @default("Pendente") // Pendente, Pago, Atrasado, Cancelado
  numeroParcela  Int?
  totalParcelas  Int?
  observacoes    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  venda Venda @relation(fields: [vendaId], references: [id], onDelete: Cascade)

  @@map("contas_receber")
}

model ContaPagar {
  id              String    @id @default(uuid())
  tipo            String    @default("FORNECEDOR") // FORNECEDOR, RH, DESPESA_FIXA
  fornecedorId    String? // Opcional para permitir despesas sem fornecedor específico
  compraId        String?
  funcionarioId   String? // Para salários (RH)
  despesaFixaId   String? // Para despesas fixas
  descricao       String
  valorParcela    Float // Valor da parcela/despesa
  dataVencimento  DateTime
  dataAgendamento DateTime? // Data agendada para pagamento
  dataPagamento   DateTime?
  status          String    @default("Pendente") // Pendente, Pago, Atrasado, Cancelado
  numeroParcela   Int?
  totalParcelas   Int?
  observacoes     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  fornecedor Fornecedor? @relation(fields: [fornecedorId], references: [id])

  @@index([tipo])
  @@index([status])
  @@map("contas_pagar")
}

// ============================================
// CONFIGURAÇÕES FISCAIS
// ============================================

model EmpresaFiscal {
  id                  String    @id @default(uuid())
  cnpj                String    @unique
  inscricaoEstadual   String
  razaoSocial         String
  nomeFantasia        String?
  endereco            String // Logradouro
  numero              String
  complemento         String?
  bairro              String
  cidade              String
  estado              String
  cep                 String
  telefone            String?
  email               String?
  regimeTributario    String // SimplesNacional, RegimeNormal, MEI
  certificadoPath     String? // Caminho do arquivo .pfx no servidor
  certificadoSenha    String? // Senha criptografada
  certificadoValidade DateTime?
  ativo               Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relações
  notasFiscais NotaFiscal[]
  nfeFila      NFeFila[]

  @@map("empresas_fiscais")
}

// ============================================
// NOTA FISCAL ELETRÔNICA
// ============================================

model NotaFiscal {
  id              String   @id @default(uuid())
  projetoId       String?
  empresaFiscalId String? // CNPJ emissor
  numero          String   @unique
  serie           String
  chaveAcesso     String?  @unique
  tipo            String // PRODUTO, SERVICO
  natureza        String // Venda de produção, Remessa, etc
  cfop            String
  valorProdutos   Float
  valorServicos   Float    @default(0)
  valorTotal      Float
  dataEmissao     DateTime @default(now())
  status          String   @default("Pendente") // Pendente, Autorizada, Cancelada
  xmlNFe          String? // XML gerado/autorizado
  observacoes     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  projeto       Projeto?       @relation(fields: [projetoId], references: [id])
  empresaFiscal EmpresaFiscal? @relation(fields: [empresaFiscalId], references: [id])
  nfeFila       NFeFila[]

  @@map("notas_fiscais")
}

// ============================================
// FILA DE ENVIO DE NF-e (CONTINGÊNCIA)
// ============================================

model NFeFila {
  id               String   @id @default(uuid())
  notaFiscalId     String?
  empresaFiscalId  String?
  ambiente         String // '1' = Produção, '2' = Homologação
  modo             String // NORMAL, SVC-AN, SVC-RS
  xmlAssinado      String // XML da NF-e já assinado (pronto para envio)
  status           String   @default("PENDENTE") // PENDENTE, ENVIANDO, ENVIADA, FALHA
  tentativas       Int      @default(0)
  ultimoErro       String?
  proximaTentativa DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  notaFiscal    NotaFiscal?    @relation(fields: [notaFiscalId], references: [id])
  empresaFiscal EmpresaFiscal? @relation(fields: [empresaFiscalId], references: [id])

  @@index([status, proximaTentativa])
  @@map("nfe_fila")
}

// ============================================
// GESTÃO OPERACIONAL - EQUIPES E ALOCAÇÕES
// ============================================

enum TipoEquipe {
  MONTAGEM
  CAMPO
  DISTINTA
}

model Equipe {
  id        String     @id @default(uuid())
  nome      String     @unique // Ex: Equipe A, Equipe B, Equipe C
  tipo      TipoEquipe
  descricao String     @default("")
  membros   String[] // Array de IDs de usuários (eletricistas)
  ativa     Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  alocacoes        AlocacaoObra[]
  alocacoesTarefas AlocacaoEquipe[]

  @@map("equipes")
}

// Alocação de equipes em tarefas específicas (novo sistema)
model AlocacaoEquipe {
  id          String         @id @default(uuid())
  tarefaId    String
  obraId      String
  equipeId    String
  dataInicio  DateTime
  dataFim     DateTime
  status      StatusAlocacao @default(PLANEJADA)
  observacoes String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  equipe Equipe @relation(fields: [equipeId], references: [id], onDelete: Cascade)

  @@index([tarefaId])
  @@index([obraId])
  @@index([equipeId])
  @@index([dataInicio, dataFim])
  @@map("alocacoes_equipe")
}

enum StatusAlocacao {
  PLANEJADA
  EM_ANDAMENTO
  CONCLUIDA
  CANCELADA
}

model AlocacaoObra {
  id              String    @id @default(uuid())
  equipeId        String? // Opcional: pode ser alocação de equipe ou eletricista individual
  eletricistaId   String? // Opcional: ID do eletricista individual (se não for equipe)
  projetoId       String // Relacionado com Projeto (Obra)
  dataInicio      DateTime
  dataFimPrevisto DateTime
  dataFimReal     DateTime?
  status          String    @default("Planejada") // Planejada, EmAndamento, Concluida, Cancelada
  observacoes     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  equipe      Equipe? @relation(fields: [equipeId], references: [id], onDelete: Cascade)
  eletricista User?   @relation("AlocacaoEletricista", fields: [eletricistaId], references: [id], onDelete: Cascade)
  projeto     Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@index([equipeId])
  @@index([eletricistaId])
  @@index([projetoId])
  @@map("alocacoes_obra")
}

// Obra representa o Projeto em fase de execução (Kanban)
model Obra {
  id                 String     @id @default(uuid())
  projetoId          String?    @unique // ✅ Opcional para obras de manutenção
  clienteId          String? // ✅ Cliente direto (para manutenção)
  nomeObra           String
  descricao          String? // ✅ Descrição da obra
  endereco           String? // ✅ Endereço da obra
  tipoObra           String     @default("PROJETO") // PROJETO ou MANUTENCAO
  status             StatusObra @default(BACKLOG)
  dataPrevistaInicio DateTime?
  dataPrevistaFim    DateTime?
  dataInicioReal     DateTime?
  dataFimReal        DateTime?
  observacoes        String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  projeto Projeto?     @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  cliente Cliente?     @relation(fields: [clienteId], references: [id])
  tarefas TarefaObra[]
  compras Compra[] // ✅ NOVO: Compras avulsas vinculadas a esta obra

  @@map("obras")
}

enum StatusObra {
  BACKLOG
  A_FAZER
  ANDAMENTO
  CONCLUIDO
}

// Tarefas dentro de cada Obra
model TarefaObra {
  id                String    @id @default(uuid())
  obraId            String
  descricao         String
  atribuidoA        String? // ID do User (eletricista/operador individual)
  equipeId          String? // ID da Equipe alocada (novo campo)
  alocacaoId        String? // ID da Alocação relacionada
  progresso         Int       @default(0) // 0 a 100
  dataPrevista      DateTime?
  dataPrevistaFim   DateTime? // Data de término prevista (para alocação de equipes)
  dataConclusaoReal DateTime?
  observacoes       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  obra               Obra                @relation(fields: [obraId], references: [id], onDelete: Cascade)
  registrosAtividade RegistroAtividade[]

  @@map("tarefas_obra")
}

// Registro de atividades/relatos diários
model RegistroAtividade {
  id                 String   @id @default(uuid())
  tarefaId           String
  usuarioId          String // ID do usuário que fez o registro
  dataRegistro       DateTime @default(now())
  descricaoAtividade String // O que foi feito (resumo do dia)
  horasTrabalhadas   Float    @default(0)
  observacoes        String?
  imagens            String[] @default([]) // URLs das imagens enviadas
  createdAt          DateTime @default(now())

  tarefa  TarefaObra @relation(fields: [tarefaId], references: [id], onDelete: Cascade)
  usuario User       @relation("RegistrosAtividade", fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@map("registros_atividade")
}

// ============================================
// GERENCIAMENTO EMPRESARIAL - RH, FROTA, PLANOS
// ============================================

// Funcionários da Empresa
model Funcionario {
  id           String   @id @default(uuid())
  nome         String
  cargo        String
  salario      Decimal  @db.Decimal(10, 2)
  dataAdmissao DateTime
  cpf          String   @unique
  telefone     String?
  email        String?
  status       String   @default("Ativo") // Ativo, Inativo, Férias, Afastado
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  vales Vale[]

  @@map("funcionarios")
}

// Vales (Transporte, Alimentação, Adiantamentos)
model Vale {
  id            String   @id @default(uuid())
  funcionarioId String
  tipo          String // Vale Transporte, Vale Alimentação, Adiantamento
  valor         Decimal  @db.Decimal(10, 2)
  data          DateTime
  descricao     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  funcionario Funcionario @relation(fields: [funcionarioId], references: [id], onDelete: Cascade)

  @@index([funcionarioId])
  @@map("vales")
}

// Veículos da Frota
model Veiculo {
  id        String   @id @default(uuid())
  modelo    String
  placa     String   @unique
  tipo      String // Carro, Caminhonete, Van, Caminhão
  ano       Int
  status    String   @default("Ativo") // Ativo, Manutenção, Inativo
  kmAtual   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gastos GastoVeiculo[]

  @@map("veiculos")
}

// Gastos dos Veículos (Combustível, Manutenção, etc)
model GastoVeiculo {
  id          String   @id @default(uuid())
  veiculoId   String
  tipo        String // Combustível, Manutenção, Seguro, IPVA, Multa, Pedágio
  descricao   String?
  valor       Decimal  @db.Decimal(10, 2)
  data        DateTime
  km          Int? // Quilometragem no momento do gasto
  obraId      String? // Obra relacionada (se aplicável)
  responsavel String? // Nome do responsável pelo gasto
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  veiculo Veiculo @relation(fields: [veiculoId], references: [id], onDelete: Cascade)

  @@index([veiculoId])
  @@index([data])
  @@map("gastos_veiculo")
}

// Planos Estratégicos da Empresa (TodoList de Evolução)
model PlanoEstrategico {
  id          String   @id @default(uuid())
  titulo      String
  descricao   String
  prazo       DateTime
  responsavel String
  prioridade  String   @default("Média") // Alta, Média, Baixa
  status      String   @default("Pendente") // Pendente, Em Andamento, Concluído, Cancelado
  categoria   String? // Financeiro, Operacional, Comercial, Tecnologia
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([prioridade])
  @@map("planos_estrategicos")
}

// Despesas Fixas da Sede (Aluguel, Energia, Internet, etc.)
model DespesaFixa {
  id            String   @id @default(uuid())
  descricao     String
  categoria     String // Aluguel, Energia, Água, Internet, Telefone, Limpeza, Segurança, Outros
  valor         Decimal  @db.Decimal(10, 2)
  diaVencimento Int // Dia do mês que vence (1-31)
  ativa         Boolean  @default(true)
  fornecedor    String? // Nome do fornecedor/empresa
  observacoes   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  pagamentos PagamentoDespesaFixa[]

  @@index([categoria])
  @@index([ativa])
  @@map("despesas_fixas")
}

// Histórico de Pagamentos das Despesas Fixas
model PagamentoDespesaFixa {
  id            String   @id @default(uuid())
  despesaFixaId String
  mesReferencia String // Ex: "2025-01", "2025-02"
  valorPago     Decimal  @db.Decimal(10, 2)
  dataPagamento DateTime
  observacoes   String?
  createdAt     DateTime @default(now())

  despesaFixa DespesaFixa @relation(fields: [despesaFixaId], references: [id], onDelete: Cascade)

  @@index([despesaFixaId])
  @@index([mesReferencia])
  @@map("pagamentos_despesa_fixa")
}

model HistoryLog {
  id        String   @id @default(uuid())
  userId    String
  userName  String
  action    String // CREATE, UPDATE, DELETE, VIEW
  module    String // Orcamentos, Clientes, Materiais, etc
  entityId  String? // ID do registro afetado
  details   String? // JSON com detalhes da ação
  ip        String?
  timestamp DateTime @default(now())

  @@index([module, timestamp])
  @@index([userId, timestamp])
  @@map("history_logs")
}

// ============================================
// GESTÃO DE FERRAMENTAS E KITS
// ============================================

// Ferramentas individuais
model Ferramenta {
  id          String   @id @default(uuid())
  nome        String
  codigo      String   @unique // Código de identificação
  categoria   String // Alicate, Chave, Multímetro, Furadeira, etc
  marca       String?
  modelo      String?
  descricao   String?
  valorCompra Float?
  quantidade  Int      @default(0) // Quantidade em estoque da ferramenta
  imagemUrl   String? // URL da foto da ferramenta
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  itensKit KitFerramentaItem[]

  @@map("ferramentas")
}

// Kits de Ferramentas para Eletricistas
model KitFerramenta {
  id              String   @id @default(uuid())
  nome            String // Ex: "Kit Eletricista Júnior", "Kit Completo"
  descricao       String?
  eletricistaId   String // ID do usuário eletricista (User)
  eletricistaNome String // Nome do eletricista (desnormalizado)
  dataEntrega     DateTime // Data de entrega do kit
  imagemUrl       String? // Foto do kit completo/termo de responsabilidade
  assinatura      String? // Assinatura digital do eletricista
  observacoes     String?
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  itens KitFerramentaItem[]

  // Relação com usuário eletricista
  eletricista User @relation("KitEletricista", fields: [eletricistaId], references: [id])

  @@index([eletricistaId])
  @@map("kits_ferramenta")
}

// Itens dentro de cada Kit
model KitFerramentaItem {
  id            String   @id @default(uuid())
  kitId         String
  ferramentaId  String
  quantidade    Int      @default(1)
  estadoEntrega String   @default("Novo") // Novo, Bom, Regular, Desgastado
  observacoes   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  kit        KitFerramenta @relation(fields: [kitId], references: [id], onDelete: Cascade)
  ferramenta Ferramenta    @relation(fields: [ferramentaId], references: [id])

  @@index([kitId])
  @@index([ferramentaId])
  @@map("kit_ferramenta_itens")
}
